{% extends "views/layouts/main.njk" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tag/macro.njk" import govukTag %}
{% import "pagination/pagination.njk" as pagination %}
{% import "pagination/pagination-options.njk" as paginationOptions %}

{% block pageContent %}
    {% if applicationUpdateStatus %}
        {{ govukNotificationBanner({
            text: "Your update was " + applicationUpdateStatus,
            type: "success"
        }) }}
    {% endif %}

    {{  govukButton({
        text: 'Create update',
        href: baseUrl + "/create"
    }) }}

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <div id="pagination" class="govuk-body">
                <p class="govuk-body govuk-clearfix">
                    <span class="govuk-body">
                        Showing <strong>{{ resultsStartNumber }}</strong> to <strong>{{ resultsEndNumber if totalApplicationUpdates > resultsEndNumber else totalApplicationUpdates }}</strong>
                        of <strong>{{ totalApplicationUpdates }}</strong> results
                    </span>
                    <span class="pins-pagination-options">
                        {{ paginationOptions.renderPagination(selectedItemsPerPage, totalApplicationUpdates, pageNumber, searchValue) }}
                    </span>
                </p>
                <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

                {{ appUpdatesTable(applicationUpdates) }}
            </div>

            {# if pageNumber and totalPages values are both 1 then pagination options not shown #}
            {{ pagination.renderPagination(pageNumber, totalPages, currentUrl) }}
        </div>
    </div>
{% endblock %}

{% macro appUpdatesTable(applicationUpdates) %}
    {% set appUpdatesRows = [] %}

    {% for update in applicationUpdates %}
        {% if update.status == "draft" %}
            {% set actionLink = "review-update" %}
            {% set statusTag %}
                {{ govukTag({ text: "Draft", classes: "govuk-tag--grey" }) }}
            {% endset %}
        {% elif update.status == "published" %}
            {% set actionLink = "review-published" %}
            {% set statusTag %}
                {{ govukTag({ text: "Published", classes: "govuk-tag--green" }) }}
            {% endset %}
        {% elif update.status == "unpublished" %}
            {% set actionLink = "review-unpublished" %}
            {% set statusTag %}
                {{ govukTag({ text: "Unpublished", classes: "govuk-tag--yellow" }) }}
            {% endset %}
        {% endif %}
        {% set appUpdatesRows = (appUpdatesRows.push([
            {
                text: update.firstPublished,
                attributes: {
                "data-sort-value": update.firstPublishedSortableValue
            }
            },
            {
                text: update.details
            },
            {
                html: statusTag
            },
            {
                html: '<a href="'+ baseUrl + '/' + update.id + '/' + actionLink +'" class="govuk-link">Review</a>'
            }
        ]), appUpdatesRows) %}
    {% endfor %}

    {% set headers = [
        {
            text: 'Published',
            attributes: {
                "aria-sort": "descending"
            }
        },
        {
            text: 'Update details'
        },
        {
            text: 'Status',
            attributes: {
                "aria-sort": "none"
            }
        },
        {
            text: 'Action'
        }
    ] %}

    {{ govukTable({
        attributes: {
            "data-module": "moj-sortable-table"
        },
        head: headers,
        rows: appUpdatesRows
    }) }}
{% endmacro %}
