{% extends layoutTemplate %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/file-upload/macro.njk" import govukFileUpload %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}

{% import "custom-components/representation-information/index.njk" as representationInformation %}

{% block before_content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            {% if errorSummary %}
                {{ govukErrorSummary({
                    titleText: "There is a problem",
                    errorList: errorSummary,
                    attributes: {"data-cy": "error-wrapper"}
                }) }}
            {% endif %}
        </div>
    </div>
{% endblock before_content %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <input type="hidden" name="_csrf" value="{{ _csrf }}">
            <h1 class="govuk-heading-l">
                {{ question.question }}
            </h1>
            <p class="govuk-body">You should not use racist, inflammatory or abusive language, or include personal information (also called special category information) about yourself or others in your comments. Any attachments will be reviewed and redacted if necessary.</p>
            <p class="govuk-body">
                You can upload the following file types:
                <br>
                {% set upperExtensions = [] %}
                {% for ext in question.allowedFileExtensions %}
                    {% set _ = upperExtensions.push(ext | upper) %}
                {% endfor %}
                {{ upperExtensions | join(", ") }}
            </p>
            <ul class="govuk-list govuk-list--bullet">
                <li>Files must not be compressed (e.g. no ZIP files)</li>
                <li>Each file must be under {{ question.maxFileSizeString }}</li>
                <li>Total upload size must be under 1GB</li>
            </ul>

            {{ representationInformation.renderRepresentationInformation("Examples of personal information") }}

            <p class="govuk-body govuk-!-font-weight-bold">Upload attachments</p>

            {% if uploadedFiles and uploadedFiles | length > 0 %}
                <dl class="govuk-summary-list">
                    {% for file in uploadedFiles %}
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__value">
                                {{ file.name }}
                            </dt>
                            <dd class="govuk-summary-list__actions">
                                <form id="deleteForm{{ loop.index }}" action="{{ currentUrl }}/delete-document/{{ file.id }}" method="POST">
                                    <input type="hidden" name="_csrf" value="{{ _csrf }}">
                                    <noscript>
                                        {{ govukButton({
                                            text: "Remove",
                                            classes: "govuk-button--warning"
                                        }) }}
                                    </noscript>
                                </form>
                                <a href="#" role="button" class="js-remove-link govuk-link js-enabled-link" data-form-id="deleteForm{{ loop.index }}">Remove</a>
                            </dd>
                        </div>
                    {% endfor %}
                </dl>
            {% endif %}

            <form id="upload-form" method="post" enctype="multipart/form-data" action="{{ currentUrl }}/upload-documents">
                <input type="hidden" name="_csrf" value="{{ _csrf }}">
                {{ govukFileUpload({
                    id: question.fieldName,
                    name: "files[]",
                    label: {
                        text: "Upload attachments",
                        classes: "govuk-visually-hidden"
                    },
                    javascript: true,
                    chooseFilesButtonText: "Select attachments",
                    dropInstructionText: "or drag and drop attachments here",
                    attributes: {
                        multiple: true,
                        accept: question.allowedMimeTypes | join(", ")
                    }
                }) }}
                <noscript>
                    {{ govukButton({
                        text: "Upload"
                    }) }}
                </noscript>
            </form>

            <form action="" method="post" novalidate>
                <input type="hidden" name="_csrf" value="{{ _csrf }}">
                <input type="hidden" name="{{ question.fieldName }}" value='{{ uploadedFilesEncoded | safe }}'>
                {{ govukButton({
                    text: continueButtonText,
                    type: "submit",
                    attributes: { "data-cy":"button-save-and-continue"}
                }) }}
            </form>

            {% set formattedTypes = "" %}
            {% for ext in upperExtensions %}
                {% if loop.last and not loop.first %}
                    {% set formattedTypes = formattedTypes + " or " + ext %}
                {% elseif loop.first %}
                    {% set formattedTypes = formattedTypes + ext %}
                {% else %}
                    {% set formattedTypes = formattedTypes + ", " + ext %}
                {% endif %}
            {% endfor %}

            <script {% if cspNonce %}nonce={{ cspNonce }}{% endif %}>
							document.addEventListener('DOMContentLoaded', function () {
								document.querySelectorAll('.js-remove-link').forEach(function (link) {
									link.addEventListener('click', function (event) {
										event.preventDefault();
										const formId = link.getAttribute('data-form-id');
										const form = document.getElementById(formId);
										if (form) form.submit();
									});
								});
							});

							document.addEventListener('DOMContentLoaded', function () {
								const fileInput = document.querySelector('#{{ question.fieldName }}-input');
								const form = document.querySelector('#upload-form');

								const allowedTypes = {{ question.allowedMimeTypes | dump | safe }};
								const maxFileSize = {{ question.maxFileSizeValue }};
								const maxFiles = 3;

								function showError(message) {
									let errorDiv = document.querySelector('#file-upload-error');
									if (!errorDiv) {
										errorDiv = document.createElement('div');
										errorDiv.id = 'file-upload-error';
										errorDiv.className = 'govuk-error-message';
										fileInput.closest('.govuk-form-group').appendChild(errorDiv);
									}
									errorDiv.textContent = message;
								}

								function clearError() {
									const errorDiv = document.querySelector('#file-upload-error');
									if (errorDiv) errorDiv.remove();
								}

								if (fileInput && form) {
									fileInput.addEventListener('change', function () {
										clearError();

										const files = fileInput.files;
										if (files.length === 0) return;

										if (files.length > maxFiles) {
											showError(`You can only upload up to ${maxFiles} files.`);
											fileInput.value = '';
											return;
										}

										for (const file of files) {
											if (!allowedTypes.includes(file.type)) {
												const formattedTypes = "{{ formattedTypes | escape | safe }}";
												showError(`The attachment must be ${formattedTypes}`);
												fileInput.value = '';
												return;
											}

											if (file.size > maxFileSize) {
												showError(`Each file must be smaller than {{ question.maxFileSizeString }}.`);
												fileInput.value = '';
												return;
											}
										}
										form.submit();
									});
								}
							});

							window.addEventListener("DOMContentLoaded", () => {
								const links = document.querySelectorAll(".js-enabled-link");
								links.forEach(link => {
									link.style.display = "inline";
								});
							});
            </script>
        </div>
    </div>
{% endblock %}
